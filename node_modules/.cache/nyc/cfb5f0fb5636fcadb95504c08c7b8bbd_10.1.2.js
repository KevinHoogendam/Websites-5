var cov_r5uwp71et=function(){var path='C:\\Users\\Kevin\\Documents\\GitHub\\Websites-5\\auth\\passport.js',hash='7315fc924988c42533dca8d50fe232d7dc0f58b3',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'C:\\Users\\Kevin\\Documents\\GitHub\\Websites-5\\auth\\passport.js',statementMap:{'0':{start:{line:1,column:22},end:{line:1,column:56}},'1':{start:{line:2,column:21},end:{line:2,column:68}},'2':{start:{line:3,column:22},end:{line:3,column:41}},'3':{start:{line:6,column:17},end:{line:6,column:42}},'4':{start:{line:8,column:11},end:{line:141,column:1}},'5':{start:{line:16,column:4},end:{line:18,column:7}},'6':{start:{line:17,column:8},end:{line:17,column:29}},'7':{start:{line:21,column:4},end:{line:25,column:7}},'8':{start:{line:22,column:8},end:{line:24,column:11}},'9':{start:{line:23,column:12},end:{line:23,column:28}},'10':{start:{line:32,column:31},end:{line:36,column:5}},'11':{start:{line:38,column:4},end:{line:74,column:8}},'12':{start:{line:41,column:8},end:{line:73,column:11}},'13':{start:{line:44,column:12},end:{line:72,column:15}},'14':{start:{line:46,column:16},end:{line:48,column:17}},'15':{start:{line:47,column:20},end:{line:47,column:37}},'16':{start:{line:51,column:16},end:{line:70,column:17}},'17':{start:{line:52,column:20},end:{line:52,column:108}},'18':{start:{line:57,column:45},end:{line:57,column:55}},'19':{start:{line:60,column:20},end:{line:60,column:57}},'20':{start:{line:61,column:20},end:{line:61,column:76}},'21':{start:{line:62,column:20},end:{line:62,column:46}},'22':{start:{line:65,column:20},end:{line:69,column:23}},'23':{start:{line:66,column:24},end:{line:67,column:38}},'24':{start:{line:67,column:28},end:{line:67,column:38}},'25':{start:{line:68,column:24},end:{line:68,column:51}},'26':{start:{line:76,column:4},end:{line:96,column:8}},'27':{start:{line:79,column:8},end:{line:94,column:11}},'28':{start:{line:81,column:12},end:{line:82,column:33}},'29':{start:{line:82,column:16},end:{line:82,column:33}},'30':{start:{line:85,column:12},end:{line:86,column:86}},'31':{start:{line:86,column:16},end:{line:86,column:86}},'32':{start:{line:89,column:12},end:{line:90,column:93}},'33':{start:{line:90,column:16},end:{line:90,column:93}},'34':{start:{line:93,column:12},end:{line:93,column:36}},'35':{start:{line:101,column:24},end:{line:105,column:9}},'36':{start:{line:107,column:4},end:{line:138,column:8}},'37':{start:{line:110,column:8},end:{line:137,column:11}},'38':{start:{line:112,column:12},end:{line:136,column:15}},'39':{start:{line:113,column:16},end:{line:114,column:37}},'40':{start:{line:114,column:20},end:{line:114,column:37}},'41':{start:{line:116,column:16},end:{line:135,column:17}},'42':{start:{line:118,column:20},end:{line:118,column:44}},'43':{start:{line:121,column:43},end:{line:121,column:53}},'44':{start:{line:124,column:20},end:{line:124,column:54}},'45':{start:{line:125,column:20},end:{line:125,column:49}},'46':{start:{line:126,column:20},end:{line:126,column:63}},'47':{start:{line:127,column:20},end:{line:127,column:67}},'48':{start:{line:128,column:20},end:{line:128,column:46}},'49':{start:{line:130,column:20},end:{line:134,column:23}},'50':{start:{line:131,column:24},end:{line:132,column:38}},'51':{start:{line:132,column:28},end:{line:132,column:38}},'52':{start:{line:133,column:24},end:{line:133,column:51}},'53':{start:{line:140,column:4},end:{line:140,column:20}},'54':{start:{line:143,column:0},end:{line:143,column:22}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:8,column:11},end:{line:8,column:12}},loc:{start:{line:8,column:26},end:{line:141,column:1}}},'1':{name:'(anonymous_1)',decl:{start:{line:16,column:27},end:{line:16,column:28}},loc:{start:{line:16,column:48},end:{line:18,column:5}}},'2':{name:'(anonymous_2)',decl:{start:{line:21,column:29},end:{line:21,column:30}},loc:{start:{line:21,column:48},end:{line:25,column:5}}},'3':{name:'(anonymous_3)',decl:{start:{line:22,column:26},end:{line:22,column:27}},loc:{start:{line:22,column:46},end:{line:24,column:9}}},'4':{name:'(anonymous_4)',decl:{start:{line:38,column:73},end:{line:38,column:74}},loc:{start:{line:38,column:113},end:{line:74,column:5}}},'5':{name:'(anonymous_5)',decl:{start:{line:41,column:25},end:{line:41,column:26}},loc:{start:{line:41,column:36},end:{line:73,column:9}}},'6':{name:'(anonymous_6)',decl:{start:{line:44,column:59},end:{line:44,column:60}},loc:{start:{line:44,column:79},end:{line:72,column:13}}},'7':{name:'(anonymous_7)',decl:{start:{line:65,column:33},end:{line:65,column:34}},loc:{start:{line:65,column:47},end:{line:69,column:21}}},'8':{name:'(anonymous_8)',decl:{start:{line:76,column:72},end:{line:76,column:73}},loc:{start:{line:76,column:112},end:{line:96,column:5}}},'9':{name:'(anonymous_9)',decl:{start:{line:79,column:55},end:{line:79,column:56}},loc:{start:{line:79,column:75},end:{line:94,column:9}}},'10':{name:'(anonymous_10)',decl:{start:{line:107,column:51},end:{line:107,column:52}},loc:{start:{line:107,column:96},end:{line:138,column:5}}},'11':{name:'(anonymous_11)',decl:{start:{line:110,column:25},end:{line:110,column:26}},loc:{start:{line:110,column:36},end:{line:137,column:9}}},'12':{name:'(anonymous_12)',decl:{start:{line:112,column:55},end:{line:112,column:56}},loc:{start:{line:112,column:75},end:{line:136,column:13}}},'13':{name:'(anonymous_13)',decl:{start:{line:130,column:33},end:{line:130,column:34}},loc:{start:{line:130,column:47},end:{line:134,column:21}}}},branchMap:{'0':{loc:{start:{line:46,column:16},end:{line:48,column:17}},type:'if',locations:[{start:{line:46,column:16},end:{line:48,column:17}},{start:{line:46,column:16},end:{line:48,column:17}}]},'1':{loc:{start:{line:51,column:16},end:{line:70,column:17}},type:'if',locations:[{start:{line:51,column:16},end:{line:70,column:17}},{start:{line:51,column:16},end:{line:70,column:17}}]},'2':{loc:{start:{line:66,column:24},end:{line:67,column:38}},type:'if',locations:[{start:{line:66,column:24},end:{line:67,column:38}},{start:{line:66,column:24},end:{line:67,column:38}}]},'3':{loc:{start:{line:81,column:12},end:{line:82,column:33}},type:'if',locations:[{start:{line:81,column:12},end:{line:82,column:33}},{start:{line:81,column:12},end:{line:82,column:33}}]},'4':{loc:{start:{line:85,column:12},end:{line:86,column:86}},type:'if',locations:[{start:{line:85,column:12},end:{line:86,column:86}},{start:{line:85,column:12},end:{line:86,column:86}}]},'5':{loc:{start:{line:89,column:12},end:{line:90,column:93}},type:'if',locations:[{start:{line:89,column:12},end:{line:90,column:93}},{start:{line:89,column:12},end:{line:90,column:93}}]},'6':{loc:{start:{line:113,column:16},end:{line:114,column:37}},type:'if',locations:[{start:{line:113,column:16},end:{line:114,column:37}},{start:{line:113,column:16},end:{line:114,column:37}}]},'7':{loc:{start:{line:116,column:16},end:{line:135,column:17}},type:'if',locations:[{start:{line:116,column:16},end:{line:135,column:17}},{start:{line:116,column:16},end:{line:135,column:17}}]},'8':{loc:{start:{line:131,column:24},end:{line:132,column:38}},type:'if',locations:[{start:{line:131,column:24},end:{line:132,column:38}},{start:{line:131,column:24},end:{line:132,column:38}}]}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var LocalStrategy=(++cov_r5uwp71et.s[0],require('passport-local').Strategy);var GoogleStrategy=(++cov_r5uwp71et.s[1],require('passport-google-oauth').OAuth2Strategy);var passport=(++cov_r5uwp71et.s[2],require('passport'));// load the auth variables
var configAuth=(++cov_r5uwp71et.s[3],require('../config/auth'));++cov_r5uwp71et.s[4];var init=function(User){++cov_r5uwp71et.f[0];++cov_r5uwp71et.s[5];// =========================================================================
// passport session setup ==================================================
// =========================================================================
// required for persistent login sessions
// passport needs ability to serialize and unserialize users out of session
// used to serialize the user for the session
passport.serializeUser(function(user,done){++cov_r5uwp71et.f[1];++cov_r5uwp71et.s[6];done(null,user._id);});// used to deserialize the user
++cov_r5uwp71et.s[7];passport.deserializeUser(function(id,done){++cov_r5uwp71et.f[2];++cov_r5uwp71et.s[8];User.findById(id,function(err,user){++cov_r5uwp71et.f[3];++cov_r5uwp71et.s[9];done(err,user);});});// =========================================================================
// LOCAL SIGNUP ============================================================
// =========================================================================
// we are using named strategies since we have one for login and one for signup
// by default, if there was no name, it would just be called 'local'
var localStrategyOptions=(++cov_r5uwp71et.s[10],{usernameField:'username',passwordField:'password',passReqToCallback:true// allows us to pass back the entire request to the callback
});++cov_r5uwp71et.s[11];passport.use('local-signup',new LocalStrategy(localStrategyOptions,function(req,username,password,done){++cov_r5uwp71et.f[4];++cov_r5uwp71et.s[12];// asynchronous
// User.findOne wont fire unless data is sent back
process.nextTick(function(){++cov_r5uwp71et.f[5];++cov_r5uwp71et.s[13];// find a user whose email is the same as the forms email
// we are checking to see if the user trying to login already exists
User.findOne({'local.username':username},function(err,user){++cov_r5uwp71et.f[6];++cov_r5uwp71et.s[14];// if there are any errors, return the error
if(err){++cov_r5uwp71et.b[0][0];++cov_r5uwp71et.s[15];return done(err);}else{++cov_r5uwp71et.b[0][1];}// check to see if theres already a user with that email
++cov_r5uwp71et.s[16];if(user){++cov_r5uwp71et.b[1][0];++cov_r5uwp71et.s[17];return done(null,false,req.flash('signupMessage','That username is already taken.'));}else{++cov_r5uwp71et.b[1][1];// if there is no user with that email
// create the user
var newUser=(++cov_r5uwp71et.s[18],new User());// set the user's local credentials
++cov_r5uwp71et.s[19];newUser.local.username=username;++cov_r5uwp71et.s[20];newUser.local.password=newUser.generateHash(password);++cov_r5uwp71et.s[21];newUser.roles=["admin"];// save the user
++cov_r5uwp71et.s[22];newUser.save(function(err){++cov_r5uwp71et.f[7];++cov_r5uwp71et.s[23];if(err){++cov_r5uwp71et.b[2][0];++cov_r5uwp71et.s[24];throw err;}else{++cov_r5uwp71et.b[2][1];}++cov_r5uwp71et.s[25];return done(null,newUser);});}});});}));++cov_r5uwp71et.s[26];passport.use('local-login',new LocalStrategy(localStrategyOptions,function(req,username,password,done){++cov_r5uwp71et.f[8];++cov_r5uwp71et.s[27];// callback with email and password from our form
// find a user whose email is the same as the forms email
// we are checking to see if the user trying to login already exists
User.findOne({'local.username':username},function(err,user){++cov_r5uwp71et.f[9];++cov_r5uwp71et.s[28];// if there are any errors, return the error before anything else
if(err){++cov_r5uwp71et.b[3][0];++cov_r5uwp71et.s[29];return done(err);}else{++cov_r5uwp71et.b[3][1];}// if no user is found, return the message
++cov_r5uwp71et.s[30];if(!user){++cov_r5uwp71et.b[4][0];++cov_r5uwp71et.s[31];return done(null,false,req.flash('loginMessage','No user found.'));}else{++cov_r5uwp71et.b[4][1];}// req.flash is the way to set flashdata using connect-flash
// if the user is found but the password is wrong
++cov_r5uwp71et.s[32];if(!user.validPassword(password)){++cov_r5uwp71et.b[5][0];++cov_r5uwp71et.s[33];return done(null,false,req.flash('loginMessage','Oops! Wrong password.'));}else{++cov_r5uwp71et.b[5][1];}// create the loginMessage and save it to session as flashdata
// all is well, return successful user
++cov_r5uwp71et.s[34];return done(null,user);});}));// =========================================================================
// GOOGLE ==================================================================
// =========================================================================
var googleOptions=(++cov_r5uwp71et.s[35],{clientID:configAuth.googleAuth.clientID,clientSecret:configAuth.googleAuth.clientSecret,callbackURL:configAuth.googleAuth.callbackURL});++cov_r5uwp71et.s[36];passport.use(new GoogleStrategy(googleOptions,function(token,refreshToken,profile,done){++cov_r5uwp71et.f[10];++cov_r5uwp71et.s[37];// make the code asynchronous
// User.findOne won't fire until we have all our data back from Google
process.nextTick(function(){++cov_r5uwp71et.f[11];++cov_r5uwp71et.s[38];// try to find the user based on their google id
User.findOne({'google.id':profile.id},function(err,user){++cov_r5uwp71et.f[12];++cov_r5uwp71et.s[39];if(err){++cov_r5uwp71et.b[6][0];++cov_r5uwp71et.s[40];return done(err);}else{++cov_r5uwp71et.b[6][1];}++cov_r5uwp71et.s[41];if(user){++cov_r5uwp71et.b[7][0];++cov_r5uwp71et.s[42];// if a user is found, log them in
return done(null,user);}else{++cov_r5uwp71et.b[7][1];// if the user isnt in our database, create a new user
var newUser=(++cov_r5uwp71et.s[43],new User());// set all of the relevant information
++cov_r5uwp71et.s[44];newUser.google.id=profile.id;++cov_r5uwp71et.s[45];newUser.google.token=token;++cov_r5uwp71et.s[46];newUser.google.name=profile.displayName;++cov_r5uwp71et.s[47];newUser.google.email=profile.emails[0].value;// pull the first email
++cov_r5uwp71et.s[48];newUser.roles=["guest"];// save the user
++cov_r5uwp71et.s[49];newUser.save(function(err){++cov_r5uwp71et.f[13];++cov_r5uwp71et.s[50];if(err){++cov_r5uwp71et.b[8][0];++cov_r5uwp71et.s[51];throw err;}else{++cov_r5uwp71et.b[8][1];}++cov_r5uwp71et.s[52];return done(null,newUser);});}});});}));++cov_r5uwp71et.s[53];return passport;};++cov_r5uwp71et.s[54];module.exports=init;